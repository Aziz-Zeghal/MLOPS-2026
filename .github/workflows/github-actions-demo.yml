name: GitHub Actions Demo
on: [push]
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
  
  Build-Docker-Image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_SECRET }}

      - name: Build and push Docker image
        run: |
          cd TP1
          IMAGE_NAME=ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/my_app:latest
          docker build --tag $IMAGE_NAME .
          docker push $IMAGE_NAME

  Deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to remote VM
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_ADDRESS }}
          password: ${{ secrets.VM_PASSWORD }}
          script: |
            IMAGE_NAME=ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/my_app:latest
            echo "Pulling latest image $IMAGE_NAME"
            docker login ghcr.io -u "${GITHUB_ACTOR,,}" -p "${{ secrets.DOCKER_SECRET }}"
            docker pull $IMAGE_NAME
            docker stop my_app || true
            docker rm my_app || true
            docker run -d --name my_app -p 80:80 $IMAGE_NAME